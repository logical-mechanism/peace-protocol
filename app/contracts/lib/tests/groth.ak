//// Copyright (C) 2025 Logical Mechanism LLC
//// SPDX-License-Identifier: GPL-3.0-only
////

use aiken/builtin.{
  bls12_381_final_verify, bls12_381_g1_add, bls12_381_g1_neg,
  bls12_381_g1_scalar_mul, bls12_381_g1_uncompress, bls12_381_g2_compress,
  bls12_381_g2_uncompress, bls12_381_miller_loop,
  bls12_381_mul_miller_loop_result,
}
use types/groth.{GrothProof, SnarkVerificationKey}

test valid_groth_proof() {
  let vk: SnarkVerificationKey =
    SnarkVerificationKey {
      nPublic: 36,
      vkAlpha: #"b9be483795a7d965ef71e9c70ef4a5ae9b6e1f0c7ff3c1a38c872155ec75a84a62f194ae51603b95cebfd2a192cc744a",
      vkBeta: #"92db1a124326df21837959fd75329b5549d3475d3c046a203ef92a2cd7775867e24d5432dd7d0f963a3d08f1ca63ea7c014f1e7fac1418d94f1f70731597805afe91c9f8e643bf0b3c15e9b5c957c123631877a4db1813e50b3114a405f4f31b",
      vkGamma: #"b7b72019045ef47ebc76d4b05fa426096c9674fba78219fecdb77528f35bee6b59620c92edd0a4807f4a6f1d5c4add4d03ce1fb3930478680294846a5f36cf3682cad806e64754c6a401b45586bdac176142acec9252be8c8a8d6a80fd218cb7",
      vkDelta: #"8479b496050932f7e864273133ba72c81e77e1cf54bb75cef9347264fc5b0f6456265e7b0199b7b172e204b198dc6b7e00ed99cb7cc29b7259c0fc2723f70be935b6a7dff4b73fd2d22a7128a7109455a61d023a5dc0c2bd4c020d6809145521",
      vkIC: [
        #"87d0524f97c4478f32545158aec4524e7fdef7eda7d0ee7c52b5c3fd69df9125321f0e5ed53321b881084d20bc9329ce",
        #"ac5992636141d6a7379be215198ac013ae7489ed06c7744b6b675b11de378ad61a2e9d2c8ef20b495a996ae685b45dd3",
        #"8bfb13434f721868cae57cf1714bf98ff6292ca112d19fd0dbc4696b3f890bf119b637c0832765e730bea8eed2f37632",
        #"a6a8b827f577cc6ed5a9745e4a69d33bc9e9c38870f93c0747304fa86c85286f8f2106ee0ca63bdd2978b4c614c9ed93",
        #"a311edd05078b220c58e5ad4ddef110dd51bb61c4e4850e559dc4a9214ef829af301d5710178ea2a8d0171b92f04ddb2",
        #"a9aa6e4c3b616bdbb6a9bb4c773373e807b21ff1206b9a7c41f53babd840b4f05ebc42ef1e3ab9ab52a56c6a803d3723",
        #"83083a24b2d4c4f97d11944665bf99d22921a03351a90605f0a3d4f381f3675a1549c9908cf7ac5d86511ff7220501e3",
        #"a52a91c73359f4daf857de639d3637e70f53f49140b6a17d7ceb820b7caa05af72cf94461fd2587b096dd25b1256c162",
        #"95877abccc9d985efc0bca18de1dc0688eec4dd1a1eac2029daeb2d85650eb6e69cc58819cc82b644a2b5531cc50be99",
        #"b43033d07f94d393c04c628229e18a1f0f80409320352618804da3fb5dc0a4ae09ee8f1c431931aad755233bc0270eb8",
        #"8067d7e8367cf21d9b635cf07c8dcd3ec83c0ef7ef884f4bdd7707b2082d7ee73a703bcfc2b3c898b07c89856f62f467",
        #"94f5c844401a8a38cbbc50893b29efaf6001bd9e0d3f8b421581026668fee6aa1714e0de1ee360891a3a523180cc923f",
        #"b8193eec2406658784642f0228eec4525518bbb15096a8580aa7a342068003f6375af489c75a4f366e6cccf8d7678b21",
        #"8000e4311fd631185c534532ab60d49b1a1470f7635ba22cc657228166ef0684298f44a64834caeeb90a786f2dcd2315",
        #"978f70bcd79704bd5284ec0ea9f16c9031d6419734dccb865bf2891139c8fc4cd6f1fed96f61f915e948ea7a04bf1479",
        #"91f8154b0e901fce9fa261d9680b81a5e7219fdeef0bebaf177dbf2a9250edd4796f494af1aef0d1b8eb46a990d2b76f",
        #"854f537172699e39ec7df2c5b3269a7e77aa8374614c403bdd6e149a6c363ae0da618cb63f0f40c71f874a3b4510f3c1",
        #"904260811709cb3702070ace3e40b2a89fbf155d11c654aa62bdc52fe54554b67d04aa46d9f94631ce260974fb42b859",
        #"abea03514ce649f1358f67e647c87e905c62d9466d91f154eed18dd6db88f7457283ba0f5cb5c65b95a65d6a6c4e858e",
        #"a57f0889bf504fbdb1f0c474e4dd77facd3ddba0bf1dc2e9baae768391d9565d7e7efeb8067ec8380b520701d2458942",
        #"84ebd82fc9435eab01d5fa056fb962259478719b7689e81bf7a7420c2121c4049accab7038892d2184470c6b61ea41be",
        #"8804d7997b0d6ebc40a387ce862454e41d713c1de89529d25cfe046d33220283ddb4a73a3113423e4cf0f4b5aa48b396",
        #"a06e1d49f6a90c16f342b5861f7303fab4521f2b818a9ec95db60c10a43b33b87d797a7fd666d26498c553ccea9e3339",
        #"8abab96eee3f7d915073d41ab351e2d0f9d4ab6ff20d237b74ccb0e7848f116e0d57bf81f9310078c9eeba8ef636ac05",
        #"aacb1236c0aacdcd0071ca28e518e1da00919148cf14658a7ba64edf8096b150b5d6579f378a82b1e7ab7af56ef405e1",
        #"a01a45fdf4d2c1296efc290f3be7f0caddc15d7b21bbeddcb679a5218b5f6c02df0c1a44557484c6aa1b3f7ea556db0f",
        #"a7c8a38ee38ac8f579b804990f749b5c13f8c862d5183bbd270e13d1b408c4f91ffb6456e922fe362cd19a43b3dd6b9a",
        #"a4fc5ed910194bb4a51273b3a1121aa0057a41428329d566d7c9e1164ef40916b231d997463750526365b483ff68150e",
        #"a72a447c261c205de6ed938c4b5e69d2092de86543f709af95463d2a94c4f7c7bf691a51fac6d47c914f660cf6b41a12",
        #"aef9c4518851eb718955d893d03928bd049224de92856c8abd6e5540fbf6963191e7d216fee93cd1db16213151cf4809",
        #"8501a0c1f47949f0e602f6a6ff2c944662a623dd199f8b0ee11f3fdfba3bfc39025434de5cad67b75590bd49ddb8a523",
        #"841f97ca9f1040269a5f9da42244eb3845599d22d52808d2a89f02b960dd80e688308e3796a922ba61a7b9561f698da2",
        #"a569afb0f0f3244510c22d670e8543795912036c0bed6ff2111a32cc09881d0e153ea3eaff2eb8101a72f7adde5dc569",
        #"8628577dfb70d34612f129f0614d41d94713d31e366885bddc9ac602c9f9baec39128344974c71499be73392e870b693",
        #"b51637f41b7e5b586c397c8672e06935e44f488baddd58031630332acc4833f7e3aa7e03fa6aac7b5258f1d95b8a6047",
        #"a38d6836e21fcdd996466d3808e049d67ed865696a9088e9197f1b6ca2c2628881d7b60363819eac3d83dcbea4ec3db4",
        #"8fa1b88bc4629972bd88b4b99b9e2601dbd3bd0598587f675860bf90992c40fe5a4c72cb59f435a8e6818f7aa844c8f0",
      ],
    }

  let pk: GrothProof =
    GrothProof {
      piA: #"81321cb2978472ecff4d329ca87c762d118ec0b0c549a452b1fe353175cfc9592ee8b023b14b0fb9b61e5e15e0e43bea",
      piB: #"a889afe1b14626e88f546843374eefdaf348df02b821b8214d1cbc1caee7bc5fd2c49900dfdee9749ed072621cbb67ba12ea93ce9b7de81fe56644d4174a44a03d98e8f2f1f6634282420cbf25aa2ebf5f73a2490936a558a33596cd3c223741",
      piC: #"95c196e4db951cbad313f4b54a19506eb1a13e1bc098a47ca940323b3308276fd40f458d49b51c75f5dfa75eb3daa910",
    }

  let public_values: List<Int> =
    [
      17500288565172873801, 9411633287470898589, 11539752139897092681,
      14117566851138557178, 11732854847018214359, 149328769413022752,
      12743184510663640417, 3586972869393599483, 1162853564816257447,
      13963573845061158233, 8519358064772266323, 300849905542043934,
      7122734010029193537, 14091438530330602714, 18437455730936055131,
      1270115798220374375, 3523544288121143632, 1409434267968882308,
      7685756809009194907, 3596529320966201100, 6136440426073328453,
      7222376003872321934, 9282423828667808000, 1484539344460549012,
      7138643491626859436, 5505419637978662744, 7017732200911399991,
      6377522435931897794, 18011877622578215533, 776479359663048414,
      10288726997180865397, 18352781759426245713, 17860951621094200122,
      3645999937606863567, 7588265706522355601, 337242724379907695,
    ]

  groth.verify_groth16(vk, pk, public_values)
}

test g2_roundtrip_beta() {
  let beta =
    #"8541197b983a417f537947eb1835f153141e96e5456e93439f54ee43644cb4207f9eff02733d6872303a3b2dedfeae4d0fa64b17e9b7825176514a3a951256a0416a1bf37982540c304d4dd135e92b87ef276a4ac8ec2349f261e741885cfc90"
  // vkBeta bytes from gnark
  bls12_381_g2_compress(bls12_381_g2_uncompress(beta)) == beta
}

test g2_roundtrip_piB() {
  let piB =
    #"8bd6079422d7fb42eb0edf2be206769ea83ba8205a7f7ec7c6b07af27eac66cbe80664a2dd589bc30e95bb8cb9df389c0390772856be15677e5603a3495e7aa771795ff91f4ecc10de478843c9657a7093fca52f01f5aef1abb461a08f1322e2"
  // proof.piB bytes from gnark
  bls12_381_g2_compress(bls12_381_g2_uncompress(piB)) == piB
}

test ml_one_is_identity() {
  let alpha =
    bls12_381_g1_uncompress(
      #"93c22fff819156d362d91460285786eb59c5e11b48f00edd8dd2d0bea081c2af48e94c87504ca55a8f9486ed6cd113f5",
    )
  let beta =
    bls12_381_g2_uncompress(
      #"8541197b983a417f537947eb1835f153141e96e5456e93439f54ee43644cb4207f9eff02733d6872303a3b2dedfeae4d0fa64b17e9b7825176514a3a951256a0416a1bf37982540c304d4dd135e92b87ef276a4ac8ec2349f261e741885cfc90",
    )

  let g1_zero = bls12_381_g1_scalar_mul(0, alpha)
  let one = bls12_381_miller_loop(g1_zero, beta)

  // If final_verify is equality-after-final-exp, one==one should be true.
  // If final_verify is product-to-one, one*one?? is not checked here; still true for equality.
  bls12_381_final_verify(one, one)
}

test final_verify_semantics_smoke() fail {
  let alpha_g1 =
    bls12_381_g1_uncompress(
      #"97f1d3a73197d7942695638c4fa9ac0fc3688c4f9774b905a14e3a3f171bac586c55e83ff97a1aeffb3af00adb22c6bb",
    )
  let beta_g2 =
    bls12_381_g2_uncompress(
      #"93e02b6052719f607dacd3a088274f65596bd0d09920b61ab5da61bbdc7f5049334cf11213945d57e5ac7d055d042b7e024aa2b2f08f0a91260805272dc51051c6e47ad4fa403b02b4510b647ae3d1770bac0326a805bbefd48056c8c121bdb8",
    )

  let x = bls12_381_miller_loop(alpha_g1, beta_g2)
  let x_inv = bls12_381_miller_loop(bls12_381_g1_neg(alpha_g1), beta_g2)

  // If final_verify checks "finalExp(x * y) == 1", then this should be True but it returns False
  bls12_381_final_verify(x, x_inv)
}

test final_verify_reflexive() {
  let a =
    bls12_381_g1_uncompress(
      #"97f1d3a73197d7942695638c4fa9ac0fc3688c4f9774b905a14e3a3f171bac586c55e83ff97a1aeffb3af00adb22c6bb",
    )
  let b =
    bls12_381_g2_uncompress(
      #"93e02b6052719f607dacd3a088274f65596bd0d09920b61ab5da61bbdc7f5049334cf11213945d57e5ac7d055d042b7e024aa2b2f08f0a91260805272dc51051c6e47ad4fa403b02b4510b647ae3d1770bac0326a805bbefd48056c8c121bdb8",
    )

  let ml = bls12_381_miller_loop(a, b)

  // MUST be True if final_verify behaves correctly for MlResult equality
  bls12_381_final_verify(ml, ml)
}

test ml_mul_matches_g1_add() {
  // use the same canonical generators you used above
  let p =
    bls12_381_g1_uncompress(
      #"97f1d3a73197d7942695638c4fa9ac0fc3688c4f9774b905a14e3a3f171bac586c55e83ff97a1aeffb3af00adb22c6bb",
    )
  let q =
    bls12_381_g2_uncompress(
      #"93e02b6052719f607dacd3a088274f65596bd0d09920b61ab5da61bbdc7f5049334cf11213945d57e5ac7d055d042b7e024aa2b2f08f0a91260805272dc51051c6e47ad4fa403b02b4510b647ae3d1770bac0326a805bbefd48056c8c121bdb8",
    )

  // x = e(p, q)
  let x = bls12_381_miller_loop(p, q)

  // x2_by_mul = e(p,q) * e(p,q) = e(p,q)^2
  let x2_by_mul = bls12_381_mul_miller_loop_result(x, x)

  // x2_by_add = e(p+p, q) = e(2p, q)
  let p2 = bls12_381_g1_add(p, p)
  let x2_by_add = bls12_381_miller_loop(p2, q)

  bls12_381_final_verify(x2_by_mul, x2_by_add)
}
