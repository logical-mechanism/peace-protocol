//// Copyright (C) 2025 Logical Mechanism LLC
//// SPDX-License-Identifier: GPL-3.0-only
////

use aiken/builtin.{
  bls12_381_final_verify, bls12_381_g1_add, bls12_381_g1_neg,
  bls12_381_g1_scalar_mul, bls12_381_g1_uncompress, bls12_381_g2_compress,
  bls12_381_g2_uncompress, bls12_381_miller_loop,
  bls12_381_mul_miller_loop_result,
}
use types/groth.{GrothProof, SnarkVerificationKey}

test valid_groth_proof() {
  let vk: SnarkVerificationKey =
    SnarkVerificationKey {
      nPublic: 36,
      vkAlpha: #"b941dd229808a03106eac0fd2378838f38e6e7e7f33909875e4703e90ce5e3182052a400b772ffe29a210c28bc9afd34",
      vkBeta: #"b06a790fe49c76230555d97d93617aeb4fb649c85ffa5ef1858cc1f1863c3321aeceb010237a4cf795097c81f13ecd460a2f82c61c579aad07c7ef9ab19043665f2a89b033107c3bdb087fd4547b461d6bf21da0ef9a82c26f728f46b047ead5",
      vkGamma: #"a6fbcc3afdd20248ad5922bbbd95ac9c9cedf3e434565035686a9c843fd01ce2edaeb1564e9df8ecb61d53a5f641e7aa125d001d23538abf91125d7b4559ce13a70de498d2a96faedbc9f3713d27c15f830fcfd239bc732229bfa5886f8bf69e",
      vkDelta: #"9167ffbe46f2a8ff2eda5339846d92d497730ad52a133994579aaf9b8ad24838b4b1f04a9e5bfb1dbc24be39bbb8d86b0d0cae0e54edf822654ae41dc0de432853f4427e9c3619777eb67f856e2e6f4c4a2aa3379d306ea97a00cde7c8bc4c2e",
      vkIC: [
        #"b686ba94f0964299bdb6f7e15b8bd6a42c0802a4f82ba1a527153c069e7d997bb90a8d651968d638fe728eafb4b2696b",
        #"95a8293a8ae37e483ef390a1c2d7ea8d5dc93fb2c146df6a788fcea1de0b69722cc0b9e467da311ed604bf7b8d892aaa",
        #"86de2e749fe98ddc91b6c17e307f6a1a80780adcd7b76d8da0cefedb8ddcc9aa2c6a45464fbc7a85f2216ec366afa8eb",
        #"87ca0e3a5ad15c5eb5233d8b2e4f8fdce2d43fd9485f2fe1e0124a3dc28b583ce6a5db7c6f68328040520bd69b7a6bb3",
        #"85e6260a348a5e1e9e5bcf6f94cb495e37524cdfeb7fac84574c1f8e9161fa58e30b5c68e91ac5784fe75c582af958aa",
        #"867dab0df9d20bcf097ff2c45b9d5bf4b1645598536146ff1463fdcc2b9133bcd85c2c5223e1ebd3a2d508d0a6958129",
        #"92d6349f0241e2b0a56131bd4427b4344e3bfca31c16a12d7322b26c57d85189de248dcd3d2aed13d6e2bb1c194aa983",
        #"8d342f5cfcfc009314e0bc69b0318d57731423a6aea8d404eb47378f39434840b9b6ee22947609874276249bff1c3e59",
        #"8e9357ba5895cbcb00de60970146d6d18b4df84b6612c7ca9e5eb4f98c48eb7fc38d130a1523ffe830a0b640375599e5",
        #"92901d4842288fe07ad5cb775eb5d269c55819f38b931e28710381a557321f94876af0ec9202f6f7444d23890fdaf0d2",
        #"b9e6f21f57f96a94ebda8135dbeee81b7376f9bf940d34f75789c3bff8f75782ffa99c833d66fba7d51cf8e258634e62",
        #"b7e7f7dd630aa76f0ff30d4151fe397f54465fdf24d2d1f586a0e652743a6d2499ecd96ef1dcfe37b6e8598e28173b87",
        #"946be392446ebe55e50082defe048db6519d7bf5b92fc3218acc0ad2ceebed65f4b5207103b3be58488235d594a3a8d6",
        #"b5777c10c50d8bbed8a74c90150f038d1a5163cde8dcaaa6e53ba3ae10c73f5efd9a84cd9299bc628b138711c4523e26",
        #"a0fac71e069aadb7fe2eae35bc8f21f1a881dd7aca7410111274089b4a24d929eaf916b43608f8e13a8f4d1b894a12dd",
        #"81fd30eca7c7c3e451cbe60dfa64379dc45c3281c154d08e72d66cb1af79a5086bfe657d021b7e80d09ea3695ebdfd64",
        #"99d49116e6e4da7d131be8df72e44c2a5f64b2de1f9c9f12f7b35275be01b278429ca9f6594396cea523189bc1d647f3",
        #"b6a32618e16122c97b9bc982e3a988e1b11de30af84c0d7282b6e97f1208533568f66451080505e4f96bcf96cfe3b4b3",
        #"8a47c46ecf923291b1a7d15647846c072a858d149e4f415b9ae86d5f4f3236a48497d2252ed9147e4db52a8d36930fbd",
        #"a590c650d1ea726870b8c24b5e0bf5c0631be77bb153061c65e0b90bee461444db2faa909199d769a045a3854a0c7197",
        #"a2b898f67f55179a32d6d80df5c1b3a8abd6f740b35e7b8749e08eac7b458160372a6753749aaae741cda81db33b5ad3",
        #"95eb35ba15771e8d4943da18e95dd75d477d86a5a2f94ac33931f8a2832f84ee23e6131e00dd53725eea659e252473f6",
        #"98c36469b6ad7f641451ecf4ccb206b1b41bb74594f80ada68c3393cdb15fd51dd3c2570ba4b6bacb92800cdeb982a05",
        #"99eb2136e447687bfa5ae625a12feb6a10c367e018af7d6c4ad11098ed7a4f87340f1a6e79f62ca7fbc1d643e1377e26",
        #"a0e2822405ef56778d0397dfed417c79255e7732097df94e936011c457bb661a37e7d5b3062ce7187096491517840713",
        #"97bb29e523867e195b696ab641e737f5420806e68d3d1cc85380f07ee3e9a57a7a62751f62d824c214533c470cb14984",
        #"ad6c9b8a94c6a2663aa75d0cfebf165a17a812a40a99a7207dd9b9746b7823813b7092105c7ac339a5afe494ccad5a50",
        #"85464daa82dbe3240f5f7ed600ae77570bc941db1b9e54646545de922fe730de47ed764f3837e116b70e737527e07414",
        #"b99e678b2e426c1b44527d7e730e5dcf26de195ffe99e789a93852844c302240166b5b9bba7fe9d99364846bed67a28d",
        #"a8340d14775c034bfeb885071370b9516c703040318407fcee83d72eaa35eea704d7f0eae893b31febc478dbeff429e6",
        #"91e8c8a3c14c2f9a3fb4385ee22eae1d978a4d42507274fdd8600a9667a34efede23356b6d9522a8d7fcae1ef4fe5efa",
        #"a631b01da93ce3395da1658b22adddf2dbd70de19b1c920389f59616af1737ca996cedbabbfb64b276f08eee4f777ab6",
        #"b492ec8fc3458a6c1f9df7f5a94515033fe81d6e90d07e946cda1269e495cc4e123627d1715bf54de670a128469bb200",
        #"95892864feaedbb79a207833bbfdacf828fdec0a554c3d5efb8ae1a5a548e0f62d87dbc27b8df0f7a5bf5c0485127e0d",
        #"996f074d2e2957ed1b228e891359608aaa2ec2ebeccf8fab1568247727629844fa3cf47535749eef51a97ff91b3f3ec8",
        #"903e5124a3e451cd133dc096ec4ed05d14ff0058f9629b7e3eff7332952fef3f386dd17ca6665b2db1cacdacb180765a",
        #"b7df2a5caf3c8dc748cb385cf884c6bd96f6d38f69290c08374cd57e21e7a316c2395c73fb472a6227e944e497aab2d8",
      ],
    }

  let pk: GrothProof =
    GrothProof {
      piA: #"a06ecc8ba58deaa2f6734259af82ee2f8de36cd7e875e3cb584bc156ae59f897afa958e02e1d4c7ce8e5b97475e56b46",
      piB: #"b0da3ae59de555a4f380fd4088b58f34ebcc2a74faf4ea9856eb2238033cb26555f4ebf9d338b75978bdc4030260ce5f097bc024a9af3f71b821b6cca7088de99f51383a6f712ce851eab2585775c6ba7a973e839c8460f29a9826f6941438ad",
      piC: #"8905af8c4362231471076c481ad266ab0833f2d9dac64dfcdba85aed92e30eb901f6bfdce2af90dfa685c9b40f7340cb",
    }

  let public_values: List<Int> =
    [
      17500288565172873801, 9411633287470898589, 11539752139897092681,
      14117566851138557178, 11732854847018214359, 149328769413022752,
      12743184510663640417, 3586972869393599483, 1162853564816257447,
      13963573845061158233, 8519358064772266323, 300849905542043934,
      7104647174194175081, 531317549079056697, 18398326682078316828,
      17418718284690568088, 6506823675508593315, 96983736607650168,
      8432226084900007735, 5235044846752215991, 6273261425546858814,
      10840774659462574510, 1798301395639797391, 1136440148908638917,
      7138643491626859436, 5505419637978662744, 7017732200911399991,
      6377522435931897794, 18011877622578215533, 776479359663048414,
      10288726997180865397, 18352781759426245713, 17860951621094200122,
      3645999937606863567, 7588265706522355601, 337242724379907695,
    ]

  groth.verify_groth16(vk, pk, public_values)
}

test g2_roundtrip_beta() {
  let beta =
    #"8541197b983a417f537947eb1835f153141e96e5456e93439f54ee43644cb4207f9eff02733d6872303a3b2dedfeae4d0fa64b17e9b7825176514a3a951256a0416a1bf37982540c304d4dd135e92b87ef276a4ac8ec2349f261e741885cfc90"
  // vkBeta bytes from gnark
  bls12_381_g2_compress(bls12_381_g2_uncompress(beta)) == beta
}

test g2_roundtrip_piB() {
  let piB =
    #"8bd6079422d7fb42eb0edf2be206769ea83ba8205a7f7ec7c6b07af27eac66cbe80664a2dd589bc30e95bb8cb9df389c0390772856be15677e5603a3495e7aa771795ff91f4ecc10de478843c9657a7093fca52f01f5aef1abb461a08f1322e2"
  // proof.piB bytes from gnark
  bls12_381_g2_compress(bls12_381_g2_uncompress(piB)) == piB
}

test ml_one_is_identity() {
  let alpha =
    bls12_381_g1_uncompress(
      #"93c22fff819156d362d91460285786eb59c5e11b48f00edd8dd2d0bea081c2af48e94c87504ca55a8f9486ed6cd113f5",
    )
  let beta =
    bls12_381_g2_uncompress(
      #"8541197b983a417f537947eb1835f153141e96e5456e93439f54ee43644cb4207f9eff02733d6872303a3b2dedfeae4d0fa64b17e9b7825176514a3a951256a0416a1bf37982540c304d4dd135e92b87ef276a4ac8ec2349f261e741885cfc90",
    )

  let g1_zero = bls12_381_g1_scalar_mul(0, alpha)
  let one = bls12_381_miller_loop(g1_zero, beta)

  // If final_verify is equality-after-final-exp, one==one should be true.
  // If final_verify is product-to-one, one*one?? is not checked here; still true for equality.
  bls12_381_final_verify(one, one)
}

test final_verify_semantics_smoke() fail {
  let alpha_g1 =
    bls12_381_g1_uncompress(
      #"97f1d3a73197d7942695638c4fa9ac0fc3688c4f9774b905a14e3a3f171bac586c55e83ff97a1aeffb3af00adb22c6bb",
    )
  let beta_g2 =
    bls12_381_g2_uncompress(
      #"93e02b6052719f607dacd3a088274f65596bd0d09920b61ab5da61bbdc7f5049334cf11213945d57e5ac7d055d042b7e024aa2b2f08f0a91260805272dc51051c6e47ad4fa403b02b4510b647ae3d1770bac0326a805bbefd48056c8c121bdb8",
    )

  let x = bls12_381_miller_loop(alpha_g1, beta_g2)
  let x_inv = bls12_381_miller_loop(bls12_381_g1_neg(alpha_g1), beta_g2)

  // If final_verify checks "finalExp(x * y) == 1", then this should be True but it returns False
  bls12_381_final_verify(x, x_inv)
}

test final_verify_reflexive() {
  let a =
    bls12_381_g1_uncompress(
      #"97f1d3a73197d7942695638c4fa9ac0fc3688c4f9774b905a14e3a3f171bac586c55e83ff97a1aeffb3af00adb22c6bb",
    )
  let b =
    bls12_381_g2_uncompress(
      #"93e02b6052719f607dacd3a088274f65596bd0d09920b61ab5da61bbdc7f5049334cf11213945d57e5ac7d055d042b7e024aa2b2f08f0a91260805272dc51051c6e47ad4fa403b02b4510b647ae3d1770bac0326a805bbefd48056c8c121bdb8",
    )

  let ml = bls12_381_miller_loop(a, b)

  // MUST be True if final_verify behaves correctly for MlResult equality
  bls12_381_final_verify(ml, ml)
}

test ml_mul_matches_g1_add() {
  // use the same canonical generators you used above
  let p =
    bls12_381_g1_uncompress(
      #"97f1d3a73197d7942695638c4fa9ac0fc3688c4f9774b905a14e3a3f171bac586c55e83ff97a1aeffb3af00adb22c6bb",
    )
  let q =
    bls12_381_g2_uncompress(
      #"93e02b6052719f607dacd3a088274f65596bd0d09920b61ab5da61bbdc7f5049334cf11213945d57e5ac7d055d042b7e024aa2b2f08f0a91260805272dc51051c6e47ad4fa403b02b4510b647ae3d1770bac0326a805bbefd48056c8c121bdb8",
    )

  // x = e(p, q)
  let x = bls12_381_miller_loop(p, q)

  // x2_by_mul = e(p,q) * e(p,q) = e(p,q)^2
  let x2_by_mul = bls12_381_mul_miller_loop_result(x, x)

  // x2_by_add = e(p+p, q) = e(2p, q)
  let p2 = bls12_381_g1_add(p, p)
  let x2_by_add = bls12_381_miller_loop(p2, q)

  bls12_381_final_verify(x2_by_mul, x2_by_add)
}
