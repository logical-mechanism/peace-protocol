//// Copyright (C) 2025 Logical Mechanism LLC
//// SPDX-License-Identifier: GPL-3.0-only
////

use aiken/builtin.{
  bls12_381_final_verify, bls12_381_g1_add, bls12_381_g1_neg,
  bls12_381_g1_scalar_mul, bls12_381_g1_uncompress, bls12_381_g2_compress,
  bls12_381_g2_uncompress, bls12_381_miller_loop,
  bls12_381_mul_miller_loop_result,
}
use types/groth.{GrothProof, SnarkVerificationKey}

/// This is failing. Need to investigate groth proofs more.
test valid_groth_proof() fail {
  let vk: SnarkVerificationKey =
    SnarkVerificationKey {
      nPublic: 36,
      vkAlpha: #"93c22fff819156d362d91460285786eb59c5e11b48f00edd8dd2d0bea081c2af48e94c87504ca55a8f9486ed6cd113f5",
      vkBeta: #"8541197b983a417f537947eb1835f153141e96e5456e93439f54ee43644cb4207f9eff02733d6872303a3b2dedfeae4d0fa64b17e9b7825176514a3a951256a0416a1bf37982540c304d4dd135e92b87ef276a4ac8ec2349f261e741885cfc90",
      vkGamma: #"85e7ce95afba3e7c1ec596953831982ca9a61b77dd24d688a8b19b311eaccd9296d5e83849f3a92227574eaff3837ce01101c3ea51d1fd9152798cf24fa4ca2a9f49f47fedbaf17159b516f71c0cde459fa0beb6d3ce72d0ccdb76c0b1063adb",
      vkDelta: #"a0d022f76ee47d0c2e215a60983be5fccec38c74e09313431e3c17812cdc3723471b5a9ef91817e50060243f5a6c195a0da9b43829bd4fd1f3c2109bf4529ed23696f7db8c967213e2fde3d258aabf0151d54b05e155ae7fac819660cef9854c",
      vkAlphaBeta: [],
      vkIC: [
        #"b8269ba208e735d72413eb19f8599348fdc9d7de67ad6ae26ec30d9bdb8b33cbca24e2ecff0c6d74694db99461c6d6fa",
        #"b75ce460a76807e444ccdccc31ace043873dc233e504d12ab445eb8d48631d92487d9c04e1052facdf6bf9c8ee1a3c2e",
        #"873b61f6833ee7a434ddb7b3bd54be94f77c6cd5a2579e4640e36eed8cc210ba3870d1cf8d75ffcdd1fd90efe54a1708",
        #"94b9bdf07cf14dfdeb86eaef5e03e00c83a49b7fbc2ff9801c41098c2a23e30f824ab42ca78321d891862c1f351e6b8e",
        #"93e0fea2e8a6c42e08e0cb30e743d84efa48b00ae086a4d8a8f99ca311e5ff3aac802c18fab8623f0909f4b04e5cb427",
        #"80c8dc058c8f1446e13e2b377a9d6d25ac1e6d2849553222993a3ab280ebe1ac7148e81548ba8f83eb3743ee466733c9",
        #"920efb38b5a2b0fc5bf0a5ea12de1b8b3cdd043bf5a73f74e9d57862efe399b1b47b6b62371341f6bee3dabb6d0969a3",
        #"b1c76694bd4ce27c38eb1faacb03cae259446cb60da48236205b470d583f9e2c00d1632dd9a47b085670ee5e44a32929",
        #"919ba5061f82efee80028b3962d5e5bcdc2a502d3ea0072f4fa2775455fe7000bd1064720bebb2b0c06d5f29d90e55af",
        #"b0131988f614dff62a1b240280cdb27cc95e8b593912c9f51355abef51dbc81d8f2956b9999b8e80689476236e0db2a0",
        #"a082e2bd47cf6aabc6c76f719e4ffc5f158fd0aa5db294de33c7db2b26be084a10fc91968f9191af813b55fca5439e59",
        #"aacaf003cf4cc08ba271c2e02731eee4d7ccea0d55ecd67d06650b9faa1a1008951abecf054a17a984c99bb69eda1080",
        #"8df3ab61b0b50fb417b1a10cb369c1049ded9f7353c87449b55a338aa98dffafa7c38f18534954cc3d1c33cafe7e1a2e",
        #"81a72449d10140be9d43279434d409d8a05bc3ffcdc25560bb8e262b421a788ea59a3beed7173ac40df6fe7d02b53449",
        #"b7a190ce12494d059b4540a7ed07d26462f57b6145c70f5c084d61d611af3a9aaec9e96d306bbffbe9a948847258d477",
        #"aea54e58329002221ff0af424c295ed9c5fa3802719f5566dcaaf7184018b1464375cb8cdb3bd2ef2c3748fb8b6df487",
        #"8e3e3b60247f2587d75ff6eaffb70a5bb02e138a274f90774f7cfa84f4c8a114eb9bdfc6caea8d1ad18466b49ac3edec",
        #"b1b5822084899c3ac048777c39444a1f15c3f62307bf4186cb931068013440df210ea71f1b29b2eb2105d2b9ec44c2db",
        #"98b212a84d9859b49c2f53e1183c41a5016bd2c1a4eab7404c0713c6d20d1ff389935e98a751e01becbb29a92fcc64be",
        #"ad0880474ce110e88cf7f16f51f5762f61d59078cf1fc5333a0924f26db074d7873f898ed1b69000c1bf6c9aa8a2142b",
        #"a3758d508192c340939de1d6daa0247d213b7515e4258b22606e6f1645eed821714ae1222a4092d9dd6a20eac557865e",
        #"95ea161d2245c2157f25e77a400dd9f871652fce6bba74cd5c4db47cfc24c9077d89f949c2933384b26ba33a07ff21f8",
        #"8e88fb97b11d475fbe634d20fdcfe0942f550b42c80dfdf2cac9254e6115b8b92c086216a42e7c4fe487bd97dd54089a",
        #"a1ef7f30b77920c0504a0c609ecb9c76827d23b67b85e03ba589882a78f545b9aea30fdb5e70a2471589ffc13669f715",
        #"87f239d2fb88443e487df439d82d70f3aa967da58df1c46e085dfa0406b24500209efc97af6176959c05893a1b3c7b07",
        #"8c8db59bc1a772ba815cd45a4890427f0d84ff08327cfca22efc816503dcc349e6913769b4141c4885eea43a9d676014",
        #"af1e0ab4b6381c3ec6b4183b6ec8ee7e9ff20cf7dbe350e97ee32a603af245c2a0e21e4df1852cbdf067b497726a1cd3",
        #"9470f0d82d14cfc5faa6ed5a748cdc9a4a3868c0bd63d1fb228a66a6cff804d9d69479a38e3f4cfe0f52f3fff6960da8",
        #"90b19e79e9d3a11fefadfd1e816931eafd581d67cf4582f67e1315ad8874f891ee7eba7e3f5f5abdd5979ff9b8486012",
        #"a17d198292bbc668b00687f55b8365a243208d097f19154210fe382d71b90f3cb8310aa75c614aeae714a2cde2bcf024",
        #"a90204acbb3aa9480030e3aaced67d0c3bbeaffed80cf5a10e8826d9adceee592db3478adfab10d1aa252a5859eb6567",
        #"a03938d1dd529798adacceb25965db1eb839e7d65aa2eca20a4dfc9ea2452edd23bec0ed87fa23a64569f89dc08c061f",
        #"889af792a739c3651fc514d32f85c42167a024a1dbe7ec61dd7d7da93059302ee97d82e5066a6e4f2f68367a7349386f",
        #"90cc9d64ea95fade244e329ec6175eb5827942c2a638f28e970b052bb34449a0d911953ac2d41f4d181d64eaf6d3d24b",
        #"a90df73314bc12333a207ea3e551d1d8abdfc8460a7df5c54005320b61ff2a53911cf1a9e812a064640e28214d26e21f",
        #"b8179038908697ef536ec1b5525ad3299ee38f1a1803d429cafa7798d7e9a8e865f3387c0ab978009bba6ae51079ae84",
        #"b52afa2f51ce08622b795d0f121fb0e1c9b97aa68b94f11d619c9c2ec239cb2e58c768e298557d45a387f3a06a47f9e8",
      ],
    }

  let pk: GrothProof =
    GrothProof {
      piA: #"b73ec6d11dd250473759bd4b5653e06fd51f916364d01901f46fa7ae16e3fa23f1bc42238344295c7b2cc8d5357f2496",
      piB: #"8bd6079422d7fb42eb0edf2be206769ea83ba8205a7f7ec7c6b07af27eac66cbe80664a2dd589bc30e95bb8cb9df389c0390772856be15677e5603a3495e7aa771795ff91f4ecc10de478843c9657a7093fca52f01f5aef1abb461a08f1322e2",
      piC: #"9921e34cd295a5c416637c40f8b1b89ef071dc97045a38f4c6747df6baf13c94912a06d2f35fc515b41a76c0313441f6",
    }

  let public_values: List<Int> =
    [
      17500288565172873801, 9411633287470898589, 11539752139897092681,
      14117566851138557178, 11732854847018214359, 149328769413022752,
      12743184510663640417, 3586972869393599483, 1162853564816257447,
      13963573845061158233, 8519358064772266323, 300849905542043934,
      7104647174194175081, 531317549079056697, 18398326682078316828,
      17418718284690568088, 6506823675508593315, 96983736607650168,
      8432226084900007735, 5235044846752215991, 6273261425546858814,
      10840774659462574510, 1798301395639797391, 1136440148908638917,
      7138643491626859436, 5505419637978662744, 7017732200911399991,
      6377522435931897794, 18011877622578215533, 776479359663048414,
      10288726997180865397, 18352781759426245713, 17860951621094200122,
      3645999937606863567, 7588265706522355601, 337242724379907695,
    ]

  groth.verify_groth16(vk, pk, public_values)
}

test g2_roundtrip_beta() {
  let beta =
    #"8541197b983a417f537947eb1835f153141e96e5456e93439f54ee43644cb4207f9eff02733d6872303a3b2dedfeae4d0fa64b17e9b7825176514a3a951256a0416a1bf37982540c304d4dd135e92b87ef276a4ac8ec2349f261e741885cfc90"
  // vkBeta bytes from gnark
  bls12_381_g2_compress(bls12_381_g2_uncompress(beta)) == beta
}

test g2_roundtrip_piB() {
  let piB =
    #"8bd6079422d7fb42eb0edf2be206769ea83ba8205a7f7ec7c6b07af27eac66cbe80664a2dd589bc30e95bb8cb9df389c0390772856be15677e5603a3495e7aa771795ff91f4ecc10de478843c9657a7093fca52f01f5aef1abb461a08f1322e2"
  // proof.piB bytes from gnark
  bls12_381_g2_compress(bls12_381_g2_uncompress(piB)) == piB
}

test ml_one_is_identity() {
  let alpha =
    bls12_381_g1_uncompress(
      #"93c22fff819156d362d91460285786eb59c5e11b48f00edd8dd2d0bea081c2af48e94c87504ca55a8f9486ed6cd113f5",
    )
  let beta =
    bls12_381_g2_uncompress(
      #"8541197b983a417f537947eb1835f153141e96e5456e93439f54ee43644cb4207f9eff02733d6872303a3b2dedfeae4d0fa64b17e9b7825176514a3a951256a0416a1bf37982540c304d4dd135e92b87ef276a4ac8ec2349f261e741885cfc90",
    )

  let g1_zero = bls12_381_g1_scalar_mul(0, alpha)
  let one = bls12_381_miller_loop(g1_zero, beta)

  // If final_verify is equality-after-final-exp, one==one should be true.
  // If final_verify is product-to-one, one*one?? is not checked here; still true for equality.
  bls12_381_final_verify(one, one)
}

test final_verify_semantics_smoke() fail {
  let alpha_g1 =
    bls12_381_g1_uncompress(
      #"97f1d3a73197d7942695638c4fa9ac0fc3688c4f9774b905a14e3a3f171bac586c55e83ff97a1aeffb3af00adb22c6bb",
    )
  let beta_g2 =
    bls12_381_g2_uncompress(
      #"93e02b6052719f607dacd3a088274f65596bd0d09920b61ab5da61bbdc7f5049334cf11213945d57e5ac7d055d042b7e024aa2b2f08f0a91260805272dc51051c6e47ad4fa403b02b4510b647ae3d1770bac0326a805bbefd48056c8c121bdb8",
    )

  let x = bls12_381_miller_loop(alpha_g1, beta_g2)
  let x_inv = bls12_381_miller_loop(bls12_381_g1_neg(alpha_g1), beta_g2)

  // If final_verify checks "finalExp(x * y) == 1", then this should be True but it returns False
  bls12_381_final_verify(x, x_inv)
}

test final_verify_reflexive() {
  let a =
    bls12_381_g1_uncompress(
      #"97f1d3a73197d7942695638c4fa9ac0fc3688c4f9774b905a14e3a3f171bac586c55e83ff97a1aeffb3af00adb22c6bb",
    )
  let b =
    bls12_381_g2_uncompress(
      #"93e02b6052719f607dacd3a088274f65596bd0d09920b61ab5da61bbdc7f5049334cf11213945d57e5ac7d055d042b7e024aa2b2f08f0a91260805272dc51051c6e47ad4fa403b02b4510b647ae3d1770bac0326a805bbefd48056c8c121bdb8",
    )

  let ml = bls12_381_miller_loop(a, b)

  // MUST be True if final_verify behaves correctly for MlResult equality
  bls12_381_final_verify(ml, ml)
}

test ml_mul_matches_g1_add() {
  // use the same canonical generators you used above
  let p =
    bls12_381_g1_uncompress(
      #"97f1d3a73197d7942695638c4fa9ac0fc3688c4f9774b905a14e3a3f171bac586c55e83ff97a1aeffb3af00adb22c6bb",
    )
  let q =
    bls12_381_g2_uncompress(
      #"93e02b6052719f607dacd3a088274f65596bd0d09920b61ab5da61bbdc7f5049334cf11213945d57e5ac7d055d042b7e024aa2b2f08f0a91260805272dc51051c6e47ad4fa403b02b4510b647ae3d1770bac0326a805bbefd48056c8c121bdb8",
    )

  // x = e(p, q)
  let x = bls12_381_miller_loop(p, q)

  // x2_by_mul = e(p,q) * e(p,q) = e(p,q)^2
  let x2_by_mul = bls12_381_mul_miller_loop_result(x, x)

  // x2_by_add = e(p+p, q) = e(2p, q)
  let p2 = bls12_381_g1_add(p, p)
  let x2_by_add = bls12_381_miller_loop(p2, q)

  bls12_381_final_verify(x2_by_mul, x2_by_add)
}
