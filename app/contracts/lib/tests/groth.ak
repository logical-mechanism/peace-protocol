//// Copyright (C) 2025 Logical Mechanism LLC
//// SPDX-License-Identifier: GPL-3.0-only
////

use aiken/builtin.{
  bls12_381_final_verify, bls12_381_g1_add, bls12_381_g1_neg,
  bls12_381_g1_scalar_mul, bls12_381_g1_uncompress, bls12_381_g2_compress,
  bls12_381_g2_uncompress, bls12_381_miller_loop,
  bls12_381_mul_miller_loop_result,
}
use types/groth.{CommitmentKey, GrothProof, SnarkVerificationKey}

test valid_groth_proof() {
  let vk: SnarkVerificationKey =
    SnarkVerificationKey {
      nPublic: 37,
      vkAlpha: #"931ec210afd48a8c2818810df698e8fa4fe98c6910691509e52838902aa4aedfede04741b2dbfaddf1853c7b3614c7ff",
      vkBeta: #"8eb11786690138e4501c6cd7df83147ea7c561e587fd5d6f02318d6fdda7430b3396efb0196bfdca68350b00979e4e7d0448dda42d87457026be0314c7ae3baa623e7b49092db66d680b416bbfbcfc56588d141ee2cd50b34d9d25c164b595f9",
      vkGamma: #"a95c50f704d3c385a3cb7cc1a20eae42d72f018f3426ff99a524fe4583d832d74d4524866b26d0e6130b577c9fb6379108ca619b25ece849971b7a24fbdfeb8a316e2ee3d738645cf626508173fe39187e5be6734d647f5cb319533b30c39387",
      vkDelta: #"b64c6fb00ee01f78ec77b8bd2d8d8e1280b18a09af93aa67b2505376f8ed40b549343b99c0eb64d5a36f9f86e983b8bb0cd256efe4e6075e312f7a2f3cd3a6e58b0b9afcf4f17730376e3644209c868fed6962ec2122c4203361a1bda6251ab4",
      vkIC: [
        #"8b112d52b38ee7d13da9dbb709003df765054ccb1e95ef27e05438b4c357fdeeba91d2e91cc522dc022d17289fc7adff",
        #"9749334a78fedcf153de056c7ff1e2ef1acef99bac9f2d10146127c1c40f01861d2e0c164e0fe34348ee187e1f7e9dd0",
        #"866d9f6c2fc70062342898cf42472e84accdd9ac33dd7558b5f843f04e3eac9c0ac8c72ab9fc445655e48e7094d34b64",
        #"8f2484c2ea857692afa648a73a91e0dfd9bfe942e779d18d8030bdb66f2c8b7d9cf56cb9c0392e893facd6d6fb4cf7c7",
        #"97f564a85eb2c56233208e9d0601db7e891b5865dca19ad7b35ab93e42f56ec33c5a78a267bbda174c3fdf2658092083",
        #"8f51745002fe6d515ae01c5fd62898c305b0e491e4f8c84c237e4100cc1e6b347af3980ab3a4823d81d1fd82f3763c15",
        #"b242ed4e6a9a05207bc0f5f2f0337a4533f2108a96dd2845a755ae55f8e0495d6de6155415c00be83c5c9d2fa49073ee",
        #"8e99a6eef9ccb37c2a6b76ae70dbee39dc8c5062d321d3c87005bf868069f753f6e390307d48a8f8b9c5f2bed51540c7",
        #"8469d565cbb13a0518fc074a175fb342ce217a5211a6ea434f4f319bef2768ad64d687ec1c5b199e24dae3c35893e18e",
        #"b4da1ba011364ff72b2933a1b42922ae6aa31a630cf427f037e65a393552827749a7de86b50c9b3fa72de6c725397e8c",
        #"87d698e66af149239fc2f947d8381cc273782ce3f4107f962a601719e649554f8b547a7b873316ab8bb254b7b9f9b4dc",
        #"8d4ec21552e69a54cd915b95e9a0795088bfcff97d23c0ed1973d8bace7ba63a89d23160cd64f7a91b4b8d6c4ca37fe4",
        #"86db70a7414728df80b1717c981471a26a2047e3a31cd2428819c0f14f1bec0bdf5cc29194d63658d53f995c0933e23f",
        #"abbaa062b6309b32bee6a79748cab046550cbc7f1aff4a235fd5ed4cb99121e8a027566d5ac602b8f2b57bc6d941e56b",
        #"95e2ae087b5f3017fff66746dbde03e77aabeb304d337b3f30dcff6faf9b996214739414c1c49b807a84f8e64e9502e6",
        #"8e65c6879300bfba77b329758d3f763c06119767577c85d00f24672fb873aebbbf9451e8092c2a18218aac5b3f62e534",
        #"97d05d65157b1fe42ad1c5aa0058d1eccfdca7dcb9176d5415b6f446d2dec8f21b3d4909a7dbc589045491a421317724",
        #"a9f90597e4aa41f5052b97031010663c1ba10f7f4737cfcc85addecec7f3cb614200433501f014a04dde91bdf041fe6b",
        #"93ce494702557a5a430d988ec48bc6cea1354f7a3a21f18cbda89e618bb2a7739b4b378346cf7722025ab761bda40365",
        #"ae72736daf705db7f26fd62855d0e115e3fc65a77574555f44b7291c72fccc9f10169d78a00d7783662ad6c7ad5e9360",
        #"965ad0bc6e8bde2f40fcf1511ba7fe56e9a62778f591d58650e3f4948c8e20a0d14c762480f35a5791c0becb4bad1619",
        #"a0ccd0e07208665822b724596f9b03e2b8c5571ec8495a7ff0a88c39455e5b038dd8cc80f0f8abce7a973d68158c84af",
        #"ae06593f0b951807afad718f1c7ff983889d44b5a44621bef81ea3dfdcf654ae7b6f133f4aa0e84cf92b5552389698c2",
        #"814a734c7ae0b6e89ebc5be0a4fe8b14e67b29a94858ac1fcb10d670696d538badf38ac34b72959c685817cf4563ea99",
        #"871c1592b606ecb8bb26d0880429a9917869b745d31df80de0b45b1011272f756aa99dbee1dbbb915befe1f901425748",
        #"847e61ba30a765f86be34fec500a7e1dc54ecb73d2afb53ca6a3bda39be2d7e34e10194c3102025b6f32a4826d1a4c83",
        #"9127ab52dc724867e60cbc55b4a1a63ff98e247654e62f72dbcc477b644b5f9c4d2f784eca1cd71098ff522de7a422a0",
        #"ac2f9ebf7edbc0b8abd23a9da00dea27eb404d38058d4caf5c36d4a06318dbf9a650285506b53e101c9ff225d61d79d4",
        #"8ad59dfc1b981dfcc72fa5e60a6d124101c4c73e8457c28cc70cba3285f6584e22c84a942098e4eece9d5a33ad085a55",
        #"b14dc9d97c64c5fb1d7992b9d770b161d9ddd5962d34a328ef2dc78372c815d72eb06faf3111532803a15dff9f7b9a0d",
        #"9159bccd30a0ed6f2728c8957ceef4c20aed369450ac670439f4b0cc7422583d7ef21555fbb9995e14694c50faed8601",
        #"b9237e12de84c21afae3fd03bc5dc67ba4fe46064004c3ecbd2f0f979e4a42bd452b4aea44d9f42c23c9aa30649c3a55",
        #"8cd59699d476855026e4f46dfba64cfc69e7a2370ea23026a60bc80f6eb8d7f83a9fc414022f09d0a73752e98aa0d43a",
        #"83c4d387631fa6ec502002890862b070ff94ab057324a21dd2aad8416e6d1a18653960d319e5ed515529d81c5ec8cb08",
        #"96eed4ff62600e9b41ba2166a6a2d87283d5b07cb132e6c09a02d857b89882629d2038b53de59c8b23c8f54e2a6b6793",
        #"a0498bb18e22f6c6b78db0ad4ea37f1a6d87b0634ff3b8cd8cbac59cc15860fbd4254a600b4b4891263ea6473002bf2a",
        #"b7376ae52922a8adbb996cf6981d21b1b694dfea70f1ca722e8e8e52b9531dc446c0332ba4403d81cdf6107a7eafa0d6",
        #"a8e64a7f702458aa2362032f979c15bb2091024b6a30da9ba2b168749e5aeaeb0c685fd92de45173e03453454055a2d5",
      ],
      commitmentKeys: [
        CommitmentKey {
          g: #"818ae3e639e49f7bd327bddceaf4d23eaab88dde1c3e9c87577793b636f5340883d3deaa14feafabb1e5b604e9ffb81a0a757c7492b9707695e9c55873d7c4627fafd1f586d23e746f70fe9d29af56a17c15fe1bd5036933cc63e834e519337b",
          gSigmaNeg: #"84dcd1b815ce74457840e6703e1bd47a0d0ef3fd7ab10f304a563787a53aacd553fc2710bf631f6f145e870af601e7bc126f30298ea1723b30d0c594a5b1c9f34f782d3ad7b84ba22542f9a4657a8388b2983556b8f15239194a1015e96785ef",
        },
      ],
    }

  let pk: GrothProof =
    GrothProof {
      piA: #"b7a3dcc8ba9c06e5dcd566ee39d1cea8ada39be7bf815cd4274576426e1d860c91ade03b431814f87dba1a79325634be",
      piB: #"a75548794667fd18c06ca7946668b603f1c122ac8ae0b1d43144aa280a92a1f305bfe739f9be9a95cc3188477a3af3860d104e6a76d91d8b2246e843ce3c4c2abfe610696bed720327dc9f9c1692862461c8bcf7f2f706d727c3c73681898c7f",
      piC: #"b4002e292c0741e22dc83e0390317e41ee5cf787cd5c6b439e01e741f4a11517e5ae49470d2e0782191040294df1b518",
      commitments: [
        #"b1e728d9977f2f2c26f48eda0dc64efd39c7899e0ded17160613d36c274e8ad4f149f3cd62e22534bdcc084936235ac9",
      ],
      commitmentPok: #"affaa54eb36d783cf1ec78699a876a08b1e9a3e4b8f3b716e2153f7a8ffbfd21a08cad0a52b79d969f739496a85c3d1e",
    }

  let public_values: List<Int> =
    [
      1, 17500288565172873801, 9411633287470898589, 11539752139897092681,
      14117566851138557178, 11732854847018214359, 149328769413022752,
      12743184510663640417, 3586972869393599483, 1162853564816257447,
      13963573845061158233, 8519358064772266323, 300849905542043934,
      7122734010029193537, 14091438530330602714, 18437455730936055131,
      1270115798220374375, 3523544288121143632, 1409434267968882308,
      7685756809009194907, 3596529320966201100, 6136440426073328453,
      7222376003872321934, 9282423828667808000, 1484539344460549012,
      7138643491626859436, 5505419637978662744, 7017732200911399991,
      6377522435931897794, 18011877622578215533, 776479359663048414,
      10288726997180865397, 18352781759426245713, 17860951621094200122,
      3645999937606863567, 7588265706522355601, 337242724379907695,
    ]

  groth.verify_groth16(vk, pk, public_values)
}

test g2_roundtrip_beta() {
  let beta =
    #"8541197b983a417f537947eb1835f153141e96e5456e93439f54ee43644cb4207f9eff02733d6872303a3b2dedfeae4d0fa64b17e9b7825176514a3a951256a0416a1bf37982540c304d4dd135e92b87ef276a4ac8ec2349f261e741885cfc90"
  // vkBeta bytes from gnark
  bls12_381_g2_compress(bls12_381_g2_uncompress(beta)) == beta
}

test g2_roundtrip_piB() {
  let piB =
    #"8bd6079422d7fb42eb0edf2be206769ea83ba8205a7f7ec7c6b07af27eac66cbe80664a2dd589bc30e95bb8cb9df389c0390772856be15677e5603a3495e7aa771795ff91f4ecc10de478843c9657a7093fca52f01f5aef1abb461a08f1322e2"
  // proof.piB bytes from gnark
  bls12_381_g2_compress(bls12_381_g2_uncompress(piB)) == piB
}

test ml_one_is_identity() {
  let alpha =
    bls12_381_g1_uncompress(
      #"93c22fff819156d362d91460285786eb59c5e11b48f00edd8dd2d0bea081c2af48e94c87504ca55a8f9486ed6cd113f5",
    )
  let beta =
    bls12_381_g2_uncompress(
      #"8541197b983a417f537947eb1835f153141e96e5456e93439f54ee43644cb4207f9eff02733d6872303a3b2dedfeae4d0fa64b17e9b7825176514a3a951256a0416a1bf37982540c304d4dd135e92b87ef276a4ac8ec2349f261e741885cfc90",
    )

  let g1_zero = bls12_381_g1_scalar_mul(0, alpha)
  let one = bls12_381_miller_loop(g1_zero, beta)

  // If final_verify is equality-after-final-exp, one==one should be true.
  // If final_verify is product-to-one, one*one?? is not checked here; still true for equality.
  bls12_381_final_verify(one, one)
}

test final_verify_semantics_smoke() fail {
  let alpha_g1 =
    bls12_381_g1_uncompress(
      #"97f1d3a73197d7942695638c4fa9ac0fc3688c4f9774b905a14e3a3f171bac586c55e83ff97a1aeffb3af00adb22c6bb",
    )
  let beta_g2 =
    bls12_381_g2_uncompress(
      #"93e02b6052719f607dacd3a088274f65596bd0d09920b61ab5da61bbdc7f5049334cf11213945d57e5ac7d055d042b7e024aa2b2f08f0a91260805272dc51051c6e47ad4fa403b02b4510b647ae3d1770bac0326a805bbefd48056c8c121bdb8",
    )

  let x = bls12_381_miller_loop(alpha_g1, beta_g2)
  let x_inv = bls12_381_miller_loop(bls12_381_g1_neg(alpha_g1), beta_g2)

  // If final_verify checks "finalExp(x * y) == 1", then this should be True but it returns False
  bls12_381_final_verify(x, x_inv)
}

test final_verify_reflexive() {
  let a =
    bls12_381_g1_uncompress(
      #"97f1d3a73197d7942695638c4fa9ac0fc3688c4f9774b905a14e3a3f171bac586c55e83ff97a1aeffb3af00adb22c6bb",
    )
  let b =
    bls12_381_g2_uncompress(
      #"93e02b6052719f607dacd3a088274f65596bd0d09920b61ab5da61bbdc7f5049334cf11213945d57e5ac7d055d042b7e024aa2b2f08f0a91260805272dc51051c6e47ad4fa403b02b4510b647ae3d1770bac0326a805bbefd48056c8c121bdb8",
    )

  let ml = bls12_381_miller_loop(a, b)

  // MUST be True if final_verify behaves correctly for MlResult equality
  bls12_381_final_verify(ml, ml)
}

test ml_mul_matches_g1_add() {
  // use the same canonical generators you used above
  let p =
    bls12_381_g1_uncompress(
      #"97f1d3a73197d7942695638c4fa9ac0fc3688c4f9774b905a14e3a3f171bac586c55e83ff97a1aeffb3af00adb22c6bb",
    )
  let q =
    bls12_381_g2_uncompress(
      #"93e02b6052719f607dacd3a088274f65596bd0d09920b61ab5da61bbdc7f5049334cf11213945d57e5ac7d055d042b7e024aa2b2f08f0a91260805272dc51051c6e47ad4fa403b02b4510b647ae3d1770bac0326a805bbefd48056c8c121bdb8",
    )

  // x = e(p, q)
  let x = bls12_381_miller_loop(p, q)

  // x2_by_mul = e(p,q) * e(p,q) = e(p,q)^2
  let x2_by_mul = bls12_381_mul_miller_loop_result(x, x)

  // x2_by_add = e(p+p, q) = e(2p, q)
  let p2 = bls12_381_g1_add(p, p)
  let x2_by_add = bls12_381_miller_loop(p2, q)

  bls12_381_final_verify(x2_by_mul, x2_by_add)
}
