<!DOCTYPE html>
<html>
<head>
  <title>SNARK Prover Test</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #eee; }
    .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
    .loading { background: #333; }
    .success { background: #1a4d1a; }
    .error { background: #4d1a1a; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    pre { background: #2a2a2a; padding: 10px; overflow-x: auto; max-height: 300px; }
    input { padding: 8px; margin: 5px; width: 600px; font-family: monospace; }
    label { display: block; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>SNARK Prover Manual Test</h1>

  <div id="status" class="status loading">Initializing...</div>

  <h2>1. Load Setup Files</h2>
  <button id="loadBtn" disabled>Load CCS + PK (~720MB)</button>
  <div id="loadStatus"></div>

  <h2>2. Generate Proof</h2>
  <div>
    <label>Secret A (hex, e.g. 0x123...):</label>
    <input type="text" id="secretA" placeholder="0x..." value="0x1234567890abcdef">

    <label>Secret R (hex, can be 0):</label>
    <input type="text" id="secretR" placeholder="0x..." value="0x0">

    <label>Public V (G1 compressed hex, 96 chars):</label>
    <input type="text" id="publicV" placeholder="compressed G1 point...">

    <label>Public W0 (G1 compressed hex, 96 chars):</label>
    <input type="text" id="publicW0" placeholder="compressed G1 point...">

    <label>Public W1 (G1 compressed hex, 96 chars):</label>
    <input type="text" id="publicW1" placeholder="compressed G1 point...">
  </div>
  <button id="proveBtn" disabled>Generate Proof</button>
  <div id="proveStatus"></div>

  <h2>Result</h2>
  <pre id="result">No proof generated yet</pre>

  <script src="wasm_exec.js"></script>
  <script>
    const go = new Go();
    let wasmReady = false;
    let setupLoaded = false;

    const statusEl = document.getElementById('status');
    const loadBtn = document.getElementById('loadBtn');
    const proveBtn = document.getElementById('proveBtn');
    const loadStatus = document.getElementById('loadStatus');
    const proveStatus = document.getElementById('proveStatus');
    const resultEl = document.getElementById('result');

    function setStatus(el, msg, type) {
      el.textContent = msg;
      el.className = 'status ' + type;
    }

    // Load WASM
    async function initWasm() {
      try {
        setStatus(statusEl, 'Loading WASM (~19MB)...', 'loading');
        const response = await fetch('prover.wasm');
        const buffer = await response.arrayBuffer();
        const result = await WebAssembly.instantiate(buffer, go.importObject);
        go.run(result.instance);
        wasmReady = true;
        setStatus(statusEl, 'WASM loaded. Ready to load setup files.', 'success');
        loadBtn.disabled = false;
      } catch (err) {
        setStatus(statusEl, 'WASM load failed: ' + err.message, 'error');
      }
    }

    // Load setup files
    loadBtn.onclick = async () => {
      loadBtn.disabled = true;
      loadStatus.textContent = 'Downloading CCS (~85MB)...';

      try {
        const ccsResp = await fetch('ccs.bin');
        const ccsBuffer = await ccsResp.arrayBuffer();
        const ccsBytes = new Uint8Array(ccsBuffer);
        loadStatus.textContent = `CCS loaded (${ccsBytes.length} bytes). Downloading PK (~613MB)...`;

        const pkResp = await fetch('pk.bin');
        const pkBuffer = await pkResp.arrayBuffer();
        const pkBytes = new Uint8Array(pkBuffer);
        loadStatus.textContent = `PK loaded (${pkBytes.length} bytes). Initializing prover...`;

        const result = gnarkLoadSetup(ccsBytes, pkBytes);
        if (result.error) {
          throw new Error(result.error);
        }

        setupLoaded = true;
        loadStatus.textContent = 'Setup loaded successfully!';
        loadStatus.style.color = '#0f0';
        proveBtn.disabled = false;
      } catch (err) {
        loadStatus.textContent = 'Load failed: ' + err.message;
        loadStatus.style.color = '#f00';
        loadBtn.disabled = false;
      }
    };

    // Generate proof
    proveBtn.onclick = async () => {
      const secretA = document.getElementById('secretA').value;
      const secretR = document.getElementById('secretR').value;
      const publicV = document.getElementById('publicV').value;
      const publicW0 = document.getElementById('publicW0').value;
      const publicW1 = document.getElementById('publicW1').value;

      if (!publicV || !publicW0 || !publicW1) {
        proveStatus.textContent = 'Please fill in all public inputs (V, W0, W1)';
        proveStatus.style.color = '#f00';
        return;
      }

      proveBtn.disabled = true;
      proveStatus.textContent = 'Generating proof (this may take 10-30 seconds)...';
      proveStatus.style.color = '#ff0';

      // Use setTimeout to let UI update
      setTimeout(() => {
        try {
          const start = Date.now();
          const result = gnarkProve(secretA, secretR, publicV, publicW0, publicW1);
          const elapsed = ((Date.now() - start) / 1000).toFixed(1);

          if (typeof result === 'string' && result.startsWith('{')) {
            const parsed = JSON.parse(result);
            resultEl.textContent = JSON.stringify(parsed, null, 2);
            proveStatus.textContent = `Proof generated in ${elapsed}s!`;
            proveStatus.style.color = '#0f0';
          } else if (result.error) {
            throw new Error(result.error);
          } else {
            resultEl.textContent = JSON.stringify(result, null, 2);
            proveStatus.textContent = `Proof generated in ${elapsed}s!`;
            proveStatus.style.color = '#0f0';
          }
        } catch (err) {
          proveStatus.textContent = 'Proof failed: ' + err.message;
          proveStatus.style.color = '#f00';
          resultEl.textContent = 'Error: ' + err.message;
        }
        proveBtn.disabled = false;
      }, 100);
    };

    // Start
    initWasm();
  </script>
</body>
</html>
